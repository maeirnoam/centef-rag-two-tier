<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - CENTEF's AI Platform</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="nav-brand">
                <a href="https://centef.org/" target="_blank" class="nav-logo-link">
                    <img src="images/CENTEF_logo_new.svg" alt="CENTEF Logo" class="nav-logo">
                </a>
                <a href="chat.html" class="nav-logo-link">
                    <img src="images/munir_logo_fixed.svg" alt="Munir Logo" class="nav-logo">
                </a>
            </div>
            <div class="nav-links">
                <a href="chat.html">Chat</a>
                <a href="contribute.html">Contribute</a>
                <a href="manifest.html" class="admin-only">Manifest</a>
                <a href="users.html" class="admin-only">Users</a>
                <div class="user-info">
                    <span class="user-email" id="user-email"></span>
                    <button class="btn btn-sm btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="split-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <h3>Chat Sessions</h3>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="createNewSession()">
                    + New Chat
                </button>
                <div id="session-list" class="session-list">
                    <div class="loading">Loading sessions...</div>
                </div>
            </div>
            
            <!-- Main Chat Area -->
            <div class="main-content">
                <div class="chat-messages" id="chat-messages">
                    <div id="welcome-screen" style="text-align: center; padding: 3rem 2rem;">
                        <img src="images/munir_logo_fixed.svg" alt="Munir Logo" style="max-width: 300px; width: 100%; height: auto; margin-bottom: 1.5rem;">
                        <p style="color: var(--text-gray); margin-bottom: 2rem; max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                            Munir is CENTEF's proprietary AI research assistant, designed to deliver clear, grounded, and transparent insights. All of Munir's responses are based directly on CENTEF's research documents as well as other trusted and verifiable sources—ensuring accuracy, reliability, and full traceability in every answer.
                        </p>

                        <div style="max-width: 600px; margin: 0 auto;">
                            <h3 style="font-size: 1rem; color: var(--text-heading); margin-bottom: 1rem;">Suggested Questions:</h3>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; text-align: left;">
                                <button class="suggestion-btn" onclick="askSuggestion(this)">
                                    What are the main methods used in terrorism financing?
                                </button>
                                <button class="suggestion-btn" onclick="askSuggestion(this)">
                                    How do financial institutions detect suspicious transactions?
                                </button>
                                <button class="suggestion-btn" onclick="askSuggestion(this)">
                                    What are the international frameworks for countering terrorism financing?
                                </button>
                                <button class="suggestion-btn" onclick="askSuggestion(this)">
                                    What role does cryptocurrency play in terrorism financing?
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Ask a question..."
                           onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
                <p style="text-align: center; font-size: 0.75rem; color: var(--text-gray); margin-top: 0.5rem; padding: 0 1rem;">
                    This AI system provides generated content that may not always be accurate or complete. Always verify information with trusted sources.
                </p>
            </div>
        </div>
    </div>
    
    <script src="js/auth.js"></script>
    <script>
        requireAuth();
        displayUserInfo();
        
        let currentSessionId = null;
        let sessions = [];
        
        // Load sessions on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSessions();
        });
        
        // Load chat sessions
        async function loadSessions() {
            try {
                sessions = await apiCall('/chat/sessions', 'GET');
                renderSessions();

                // Don't auto-select any session - show welcome screen
            } catch (error) {
                console.error('Failed to load sessions:', error);
                showError('Failed to load chat sessions');
            }
        }
        
        // Render session list
        function renderSessions() {
            const sessionList = document.getElementById('session-list');
            if (sessions.length === 0) {
                sessionList.innerHTML = '<p style="color: var(--text-gray);">No sessions yet</p>';
                return;
            }
            
            sessionList.innerHTML = sessions.map(session => `
                <div class="session-item ${session.session_id === currentSessionId ? 'active' : ''}" 
                     onclick="selectSession('${session.session_id}')">
                    <div style="font-weight: 500;">${escapeHtml(session.title || 'New Chat')}</div>
                    <div style="font-size: 0.75rem; color: var(--text-gray);">
                        ${new Date(session.created_at).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }
        
        // Select a session
        async function selectSession(sessionId) {
            currentSessionId = sessionId;
            renderSessions();
            await loadChatHistory(sessionId);
        }
        
        // Create new session
        async function createNewSession() {
            try {
                const newSession = await apiCall('/chat/sessions', 'POST');
                sessions.unshift(newSession);
                selectSession(newSession.session_id);
            } catch (error) {
                console.error('Failed to create session:', error);
                showError('Failed to create new session');
            }
        }
        
        // Load chat history for a session
        async function loadChatHistory(sessionId) {
            try {
                const messages = await apiCall(`/chat/history/${sessionId}`, 'GET');
                renderMessages(messages);
            } catch (error) {
                console.error('Failed to load chat history:', error);
                showError('Failed to load chat history');
            }
        }
        
        // Handle suggestion click
        function askSuggestion(button) {
            const question = button.textContent.trim();
            document.getElementById('chat-input').value = question;
            sendMessage();
        }

        // Render messages
        function renderMessages(messages) {
            const chatMessages = document.getElementById('chat-messages');

            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div id="welcome-screen" style="text-align: center; padding: 3rem 2rem;">
                        <img src="images/munir_logo_fixed.svg" alt="Munir Logo" style="max-width: 300px; width: 100%; height: auto; margin-bottom: 1.5rem;">
                        <p style="color: var(--text-gray); margin-bottom: 2rem; max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                            Munir is CENTEF's proprietary AI research assistant, designed to deliver clear, grounded, and transparent insights. All of Munir's responses are based directly on CENTEF's research documents as well as other trusted and verifiable sources—ensuring accuracy, reliability, and full traceability in every answer.
                        </p>

                        <div style="max-width: 600px; margin: 0 auto;">
                            <h3 style="font-size: 1rem; color: var(--text-heading); margin-bottom: 1rem;">Suggested Questions:</h3>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; text-align: left;">
                                <button class="suggestion-btn" onclick="askSuggestion(this)">
                                    What are the main methods used in terrorism financing?
                                </button>
                                <button class="suggestion-btn" onclick="askSuggestion(this)">
                                    How do financial institutions detect suspicious transactions?
                                </button>
                                <button class="suggestion-btn" onclick="askSuggestion(this)">
                                    What are the international frameworks for countering terrorism financing?
                                </button>
                                <button class="suggestion-btn" onclick="askSuggestion(this)">
                                    What role does cryptocurrency play in terrorism financing?
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            chatMessages.innerHTML = messages.map(msg => {
                if (msg.role === 'user') {
                    return `
                        <div class="chat-message user">
                            <div class="message-bubble">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                } else {
                    let sourcesHtml = '';
                    if (msg.sources && msg.sources.length > 0) {
                        sourcesHtml = `
                            <div class="message-sources">
                                <h4>Sources:</h4>
                                ${formatSources(msg.sources)}
                            </div>
                        `;
                    }

                    return `
                        <div class="chat-message assistant">
                            <div class="message-bubble">${formatAnswer(msg.content, msg.sources)}</div>
                            ${sourcesHtml}
                        </div>
                    `;
                }
            }).join('');
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();

            if (!query) return;

            // Hide welcome screen if it exists (do this FIRST before anything else)
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.remove();
            }

            // Create session if none exists (but don't load its empty history)
            if (!currentSessionId) {
                try {
                    const newSession = await apiCall('/chat/sessions', 'POST');
                    sessions.unshift(newSession);
                    currentSessionId = newSession.session_id;
                    renderSessions(); // Update session list UI
                } catch (error) {
                    console.error('Failed to create session:', error);
                    showError('Failed to create new session');
                    return;
                }
            }

            // Add user message to UI immediately
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML += `
                <div class="chat-message user">
                    <div class="message-bubble">${escapeHtml(query)}</div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Clear input
            input.value = '';
            input.disabled = true;

            // Show loading indicator with rotating messages
            const loadingMessages = [
                "CENTEF's AI researcher is searching the knowledge base...",
                "Analyzing counter-terrorism financing documents...",
                "Reviewing regulatory frameworks and compliance guidelines...",
                "Examining financial intelligence reports...",
                "Cross-referencing international CTF standards...",
                "Synthesizing findings from multiple sources..."
            ];

            let messageIndex = 1; // Start at 1 since we're displaying message 0 first
            const loadingId = 'loading-' + Date.now();

            chatMessages.innerHTML += `
                <div class="chat-message assistant" id="${loadingId}">
                    <div class="message-bubble" style="display: flex; align-items: center; gap: 0.75rem;">
                        <div class="spinner" style="width: 20px; height: 20px; flex-shrink: 0;"></div>
                        <div class="loading-text" style="color: var(--text-gray); font-style: italic;">${loadingMessages[0]}</div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Rotate loading messages every 2 seconds
            const loadingInterval = setInterval(() => {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    const messageText = loadingElement.querySelector('.loading-text');
                    if (messageText) {
                        messageText.textContent = loadingMessages[messageIndex];
                        messageIndex = (messageIndex + 1) % loadingMessages.length;
                    }
                }
            }, 2000);
            
            try {
                const data = await apiCall('/chat', 'POST', {
                    query: query,
                    session_id: currentSessionId
                });

                // Clear loading interval
                clearInterval(loadingInterval);

                // Remove loading indicator
                document.getElementById(loadingId)?.remove();

                // Add assistant response
                let sourcesHtml = '';
                if (data.sources && data.sources.length > 0) {
                    sourcesHtml = `
                        <div class="message-sources">
                            <h4>Sources:</h4>
                            ${formatSources(data.sources)}
                        </div>
                    `;
                }

                chatMessages.innerHTML += `
                    <div class="chat-message assistant">
                        <div class="message-bubble">${formatAnswer(data.answer, data.sources)}</div>
                        ${sourcesHtml}
                    </div>
                `;

                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                // Clear loading interval
                clearInterval(loadingInterval);
                document.getElementById(loadingId)?.remove();
                console.error('Failed to send message:', error);
                showError('Failed to send message');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatSources(sources) {
            if (!sources || sources.length === 0) return '';

            return sources.map((src, index) => {
                const citationNum = index + 1;

                // Handle if source is an object
                if (typeof src === 'object') {
                    const title = src.title || src.filename || src.source_id || 'Unknown Document';
                    const rawSourceUri = src.source_uri || '';
                    const authorizedUrl = toAuthorizedUrl(rawSourceUri, src.authorized_url);
                    const pages = src.pages || [];
                    const pageRange = src.page_range || '';

                    let displayText = `<strong>[${citationNum}]</strong> ${escapeHtml(title)}`;

                    // Add page information as integers
                    if (pageRange) {
                        // Convert page_range to integers (e.g., "3.0-10.0" -> "3-10")
                        const cleanPageRange = pageRange.replace(/(\d+)\.0/g, '$1');
                        displayText += `, ${cleanPageRange}`;
                    } else if (pages && pages.length > 0) {
                        const intPages = pages.map(p => Math.floor(parseFloat(p)));
                        if (intPages.length === 1) {
                            displayText += `, page ${intPages[0]}`;
                        } else if (intPages.length === 2 && intPages[1] - intPages[0] === 1) {
                            displayText += `, pages ${intPages[0]}-${intPages[1]}`;
                        } else {
                            displayText += `, pages ${intPages.join(', ')}`;
                        }
                    }

                    displayText += '.';

                    // Make clickable if we have a url we can open
                    if (authorizedUrl) {
                        return `<div id="source-${citationNum}" style="margin: 0.5rem 0;"><a href="${escapeHtml(authorizedUrl)}" target="_blank" style="color: var(--primary-color); text-decoration: none; hover: text-decoration: underline;">${displayText}</a></div>`;
                    } else {
                        return `<div id="source-${citationNum}" style="margin: 0.5rem 0;">${displayText}</div>`;
                    }
                } else {
                    // Handle string sources (legacy format)
                    return `<div id="source-${citationNum}" style="margin: 0.5rem 0;"><strong>[${citationNum}]</strong> ${escapeHtml(String(src))}</div>`;
                }
            }).join('');
        }
        
        function toAuthorizedUrl(sourceUri, preferredUrl) {
            if (preferredUrl) return preferredUrl;
            if (!sourceUri) return '';

            if (sourceUri.startsWith('http://') || sourceUri.startsWith('https://')) {
                return sourceUri;
            }

            if (sourceUri.startsWith('gs://')) {
                const withoutScheme = sourceUri.slice(5);
                if (!withoutScheme) return '';

                const [bucket, ...pathParts] = withoutScheme.split('/');
                if (!bucket) return '';

                const encodedPath = pathParts.length
                    ? pathParts.map(part => encodeURIComponent(part)).join('/')
                    : '';

                return encodedPath
                    ? `https://storage.cloud.google.com/${bucket}/${encodedPath}`
                    : `https://storage.cloud.google.com/${bucket}`;
            }

            return sourceUri;
        }
        
        function formatAnswer(text, sources) {
            // Convert markdown-style bold and italic
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Parse inline citations and convert to numbered format with page anchors
            // Match patterns like [Document Title, Page X] or [Document Title, Pages X-Y]
            text = text.replace(/\[([^\]]+?),\s*Page(?:s)?\s+([0-9\.\-,\s]+)\]/gi, (match, docTitle, pageInfo) => {
                // Find the source index by matching document title
                const sourceIndex = sources ? sources.findIndex(src => {
                    const title = src.title || src.filename || src.source_id || '';
                    return title.toLowerCase().includes(docTitle.toLowerCase().trim()) ||
                           docTitle.toLowerCase().trim().includes(title.toLowerCase());
                }) : -1;

                if (sourceIndex >= 0) {
                    const citationNum = sourceIndex + 1;
                    // Clean up page info - remove decimals (.0) and extra spaces
                    const cleanPageInfo = pageInfo.trim().replace(/(\d+)\.0/g, '$1').replace(/\s+/g, ' ');
                    const pageLabel = cleanPageInfo.includes('-') || cleanPageInfo.includes(',') ? 'pages' : 'page';
                    return `<a href="#source-${citationNum}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;" onclick="document.getElementById('source-${citationNum}').scrollIntoView({behavior: 'smooth'}); return false;">[${citationNum}, ${pageLabel} ${cleanPageInfo}]</a>`;
                }
                return match; // Keep original if not found
            });

            // Also handle simpler citation formats like [Document Title] without page numbers
            text = text.replace(/\[([^\]]+?)\]/g, (match, docTitle) => {
                // Skip if it's already a citation number (e.g., [1])
                if (/^\d+$/.test(docTitle.trim())) {
                    return match;
                }

                // Find the source index by matching document title
                const sourceIndex = sources ? sources.findIndex(src => {
                    const title = src.title || src.filename || src.source_id || '';
                    return title.toLowerCase().includes(docTitle.toLowerCase().trim()) ||
                           docTitle.toLowerCase().trim().includes(title.toLowerCase());
                }) : -1;

                if (sourceIndex >= 0) {
                    const citationNum = sourceIndex + 1;
                    return `<a href="#source-${citationNum}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;" onclick="document.getElementById('source-${citationNum}').scrollIntoView({behavior: 'smooth'}); return false;">[${citationNum}]</a>`;
                }
                return match; // Keep original if not found
            });

            // Convert line breaks
            text = text.replace(/\n/g, '<br>');

            return text;
        }
    </script>
</body>
</html>
