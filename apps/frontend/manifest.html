<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifest - CENTEF RAG System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="nav-brand">
                <a href="https://centef.org/" target="_blank" class="nav-logo-link">
                    <img src="images/CENTEF_logo_new.svg" alt="CENTEF Logo" class="nav-logo">
                </a>
                <a href="chat.html" class="nav-logo-link">
                    <img src="images/Munir_logo_new.png" alt="Munir Logo" class="nav-logo">
                </a>
            </div>
            <div class="nav-links">
                <a href="chat.html">Chat</a>
                <a href="manifest.html" class="admin-only">Manifest</a>
                <a href="users.html" class="admin-only">Users</a>
                <div class="user-info">
                    <span class="user-email" id="user-email"></span>
                    <button class="btn btn-sm btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h1>Document Manifest</h1>
                <div>
                    <button class="btn btn-secondary" onclick="loadManifest()">â†» Refresh</button>
                    <button class="btn btn-primary admin-only" onclick="showPendingApprovals()" style="margin-left: 0.5rem;">
                        Pending Approvals
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label>
                    Filter by status: 
                    <select id="status-filter" onchange="loadManifest()" style="padding: 0.5rem; margin-left: 0.5rem;">
                        <option value="">All</option>
                        <option value="pending_processing">Pending Processing</option>
                        <option value="pending_summary">Pending Summary</option>
                        <option value="pending_approval">Pending Approval</option>
                        <option value="pending_embedding">Pending Embedding</option>
                        <option value="embedded">Embedded</option>
                        <option value="error">Error</option>
                    </select>
                </label>
            </div>
            
            <div id="manifest-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading manifest...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 2rem 0;">
        <div style="max-width: 600px; width: 90%; margin: 2rem auto; background: white; border-radius: 0.5rem; padding: 2rem; max-height: calc(100vh - 4rem); overflow-y: auto;">
            <h2 id="modal-title">Edit Document</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-source-id">
                
                <div class="form-group">
                    <label for="edit-title">Title</label>
                    <input type="text" id="edit-title" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-author">Author</label>
                    <input type="text" id="edit-author">
                </div>
                
                <div class="form-group">
                    <label for="edit-organization">Organization</label>
                    <input type="text" id="edit-organization">
                </div>
                
                <div class="form-group">
                    <label for="edit-date">Date</label>
                    <input type="text" id="edit-date" placeholder="MM-DD-YYYY" pattern="\d{2}-\d{2}-\d{4}" title="Please use MM-DD-YYYY format (e.g., 12-31-2024)">
                </div>
                
                <div class="form-group">
                    <label for="edit-publisher">Publisher</label>
                    <input type="text" id="edit-publisher">
                </div>
                
                <div class="form-group">
                    <label for="edit-tags">Tags (comma-separated)</label>
                    <input type="text" id="edit-tags" placeholder="terrorism, financing, policy">
                </div>
                
                <div class="form-group admin-only">
                    <label for="edit-status">Status</label>
                    <select id="edit-status">
                        <option value="pending_processing">Pending Processing</option>
                        <option value="pending_summary">Pending Summary</option>
                        <option value="pending_approval">Pending Approval</option>
                        <option value="pending_embedding">Pending Embedding</option>
                        <option value="embedded">Embedded</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-notes">Notes</label>
                    <textarea id="edit-notes"></textarea>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="button" class="btn btn-success admin-only" id="approve-btn" onclick="approveDocument()" style="margin-left: auto; display: none;">
                        âœ“ Approve & Index
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="js/auth.js"></script>
    <script>
        requireAuth();
        displayUserInfo();

        let manifestData = [];

        // Date conversion helpers
        function formatDateForDisplay(isoDate) {
            // Convert YYYY-MM-DD to MM-DD-YYYY
            if (!isoDate || !isoDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return isoDate || '-';
            }
            const [year, month, day] = isoDate.split('-');
            return `${month}-${day}-${year}`;
        }

        function formatDateForStorage(displayDate) {
            // Convert MM-DD-YYYY to YYYY-MM-DD
            if (!displayDate || !displayDate.match(/^\d{2}-\d{2}-\d{4}$/)) {
                return displayDate || '';
            }
            const [month, day, year] = displayDate.split('-');
            return `${year}-${month}-${day}`;
        }

        // Load manifest on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadManifest();
        });
        
        // Load manifest
        async function loadManifest() {
            const statusFilter = document.getElementById('status-filter').value;
            const url = statusFilter ? `/manifest?status=${statusFilter}` : '/manifest';
            
            document.getElementById('manifest-content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading manifest...</p>
                </div>
            `;
            
            try {
                manifestData = await apiCall(url, 'GET');
                renderManifest(manifestData);
            } catch (error) {
                console.error('Failed to load manifest:', error);
                showError('Failed to load manifest');
            }
        }
        
        // Render manifest table
        function renderManifest(data) {
            const content = document.getElementById('manifest-content');
            
            if (data.length === 0) {
                content.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 2rem;">No documents found</p>';
                return;
            }
            
            content.innerHTML = `
                <table class="manifest-table">
                    <thead>
                        <tr>
                            <th>Source ID</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(doc => `
                            <tr>
                                <td><code>${escapeHtml(doc.source_id)}</code></td>
                                <td>${escapeHtml(doc.title || 'Untitled')}</td>
                                <td>${escapeHtml(doc.author || '-')}</td>
                                <td>${formatDateForDisplay(doc.date)}</td>
                                <td><span class="status-badge status-${doc.status}">${escapeHtml(doc.status)}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="toggleMetadata('${doc.source_id}')" style="margin-right: 0.25rem;">
                                        View More
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="editDocument('${doc.source_id}')">
                                        Edit
                                    </button>
                                    ${doc.status === 'pending_approval' && isAdmin() ? `
                                        <button class="btn btn-sm btn-success" onclick="approveDocumentQuick('${doc.source_id}')">
                                            Approve
                                        </button>
                                    ` : ''}
                                    ${isAdmin() ? `
                                        <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.source_id}', '${escapeHtml(doc.title || doc.source_id)}')">
                                            Delete
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                            <tr id="metadata-${doc.source_id}" class="metadata-row" style="display: none;">
                                <td colspan="6" style="background-color: var(--bg-light); padding: 1.5rem;">
                                    <div style="max-width: 100%;">
                                        <h3 style="margin-bottom: 1rem; color: var(--text-heading);">Document Metadata</h3>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                            <div>
                                                <strong>Source ID:</strong><br>
                                                <code style="word-break: break-all;">${escapeHtml(doc.source_id)}</code>
                                            </div>
                                            <div>
                                                <strong>Title:</strong><br>
                                                ${escapeHtml(doc.title || 'N/A')}
                                            </div>
                                            <div>
                                                <strong>Author:</strong><br>
                                                ${escapeHtml(doc.author || 'N/A')}
                                            </div>
                                            <div>
                                                <strong>Organization:</strong><br>
                                                ${escapeHtml(doc.organization || 'N/A')}
                                            </div>
                                            <div>
                                                <strong>Date:</strong><br>
                                                ${formatDateForDisplay(doc.date)}
                                            </div>
                                            <div>
                                                <strong>Publisher:</strong><br>
                                                ${escapeHtml(doc.publisher || 'N/A')}
                                            </div>
                                            <div>
                                                <strong>Status:</strong><br>
                                                <span class="status-badge status-${doc.status}">${escapeHtml(doc.status)}</span>
                                            </div>
                                            <div>
                                                <strong>Tags:</strong><br>
                                                ${doc.tags && doc.tags.length > 0 ? doc.tags.map(tag => `<span class="tag-badge">${escapeHtml(tag)}</span>`).join(' ') : 'N/A'}
                                            </div>
                                        </div>
                                        ${doc.summary_path ? `
                                            <div style="margin-top: 1rem;">
                                                <strong>Summary:</strong>
                                                <div id="summary-${doc.source_id}" style="background-color: var(--bg-white); padding: 1rem; border-radius: 0.375rem; margin-top: 0.5rem; border: 1px solid var(--border-color); max-height: 300px; overflow-y: auto;">
                                                    <em style="color: var(--text-gray);">Loading...</em>
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${doc.notes ? `
                                            <div style="margin-top: 1rem;">
                                                <strong>Notes:</strong>
                                                <div style="background-color: var(--bg-white); padding: 1rem; border-radius: 0.375rem; margin-top: 0.5rem; border: 1px solid var(--border-color);">
                                                    ${escapeHtml(doc.notes).replace(/\n/g, '<br>')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${doc.source_uri || doc.authorized_url ? `
                                            <div style="margin-top: 1rem;">
                                                <strong>Source Document:</strong><br>
                                                ${getAuthorizedUrl(doc.source_uri, doc.authorized_url) ? `
                                                    <a href="${escapeHtml(getAuthorizedUrl(doc.source_uri, doc.authorized_url))}" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                                        ðŸ“„ View Document
                                                    </a>
                                                ` : `<code style="word-break: break-all;">${escapeHtml(doc.source_uri)}</code>`}
                                            </div>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Show pending approvals
        async function showPendingApprovals() {
            if (!isAdmin()) {
                showError('Admin access required');
                return;
            }
            
            try {
                const pending = await apiCall('/admin/manifest/pending', 'GET');
                manifestData = pending;
                renderManifest(pending);
                document.getElementById('status-filter').value = '';
            } catch (error) {
                console.error('Failed to load pending approvals:', error);
                showError('Failed to load pending approvals');
            }
        }
        
        // Edit document
        function editDocument(sourceId) {
            const doc = manifestData.find(d => d.source_id === sourceId);
            if (!doc) return;

            document.getElementById('edit-source-id').value = doc.source_id;
            document.getElementById('edit-title').value = doc.title || '';
            document.getElementById('edit-author').value = doc.author || '';
            document.getElementById('edit-organization').value = doc.organization || '';
            document.getElementById('edit-date').value = formatDateForDisplay(doc.date);
            document.getElementById('edit-publisher').value = doc.publisher || '';
            document.getElementById('edit-tags').value = doc.tags?.join(', ') || '';
            document.getElementById('edit-status').value = doc.status || '';
            document.getElementById('edit-notes').value = doc.notes || '';
            
            // Show approve button for pending_approval documents (admin only)
            const approveBtn = document.getElementById('approve-btn');
            if (doc.status === 'pending_approval' && isAdmin()) {
                approveBtn.style.display = 'block';
            } else {
                approveBtn.style.display = 'none';
            }
            
            document.getElementById('modal-title').textContent = `Edit: ${doc.title || doc.source_id}`;
            document.getElementById('edit-modal').style.display = 'block';
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-form').reset();
        }
        
        // Save document changes
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const sourceId = document.getElementById('edit-source-id').value;
            const tags = document.getElementById('edit-tags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);

            const updates = {
                title: document.getElementById('edit-title').value,
                author: document.getElementById('edit-author').value,
                organization: document.getElementById('edit-organization').value,
                date: formatDateForStorage(document.getElementById('edit-date').value),
                publisher: document.getElementById('edit-publisher').value,
                tags: tags,
                notes: document.getElementById('edit-notes').value
            };
            
            // Add status if admin
            if (isAdmin()) {
                updates.status = document.getElementById('edit-status').value;
            }
            
            try {
                const result = await apiCall(`/manifest/${sourceId}`, 'PUT', updates);
                showSuccess('Document updated successfully');
                closeEditModal();
                loadManifest();
            } catch (error) {
                console.error('Failed to update document:', error);
                showError('Failed to update document');
            }
        });
        
        // Approve document (from modal)
        async function approveDocument() {
            const sourceId = document.getElementById('edit-source-id').value;
            await approveDocumentQuick(sourceId);
            closeEditModal();
        }
        
        // Quick approve (from table)
        async function approveDocumentQuick(sourceId) {
            if (!isAdmin()) {
                showError('Admin access required');
                return;
            }
            
            if (!confirm('Approve this document and trigger indexing?')) {
                return;
            }
            
            try {
                const result = await apiCall(`/admin/manifest/${sourceId}/approve`, 'PUT', { approved: true });
                showSuccess('Document approved and queued for indexing');
                loadManifest();
            } catch (error) {
                console.error('Failed to approve document:', error);
                showError('Failed to approve document');
            }
        }
        
        // Toggle metadata visibility
        async function toggleMetadata(sourceId) {
            const metadataRow = document.getElementById(`metadata-${sourceId}`);
            const button = event.target;

            if (metadataRow.style.display === 'none') {
                metadataRow.style.display = 'table-row';
                button.textContent = 'Hide Details';

                // Load summary if not already loaded
                const summaryContainer = document.getElementById(`summary-${sourceId}`);
                if (summaryContainer && !summaryContainer.dataset.loaded) {
                    summaryContainer.innerHTML = '<div style="padding: 1rem; color: var(--text-gray);"><div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div></div>';

                    try {
                        const doc = manifestData.find(d => d.source_id === sourceId);
                        if (doc && doc.summary_path) {
                            // Fetch summary from API endpoint
                            const summaryData = await apiCall(`/manifest/${sourceId}/summary`, 'GET');

                            if (summaryData && summaryData.summary_text) {
                                summaryContainer.innerHTML = escapeHtml(summaryData.summary_text).replace(/\n/g, '<br>');
                                summaryContainer.dataset.loaded = 'true';
                            } else {
                                summaryContainer.innerHTML = '<em style="color: var(--text-gray);">No summary text found</em>';
                            }
                        } else {
                            summaryContainer.innerHTML = '<em style="color: var(--text-gray);">No summary available</em>';
                        }
                    } catch (error) {
                        console.error('Error loading summary:', error);
                        summaryContainer.innerHTML = `<em style="color: var(--text-gray);">Error: ${error.message}</em>`;
                    }
                }
            } else {
                metadataRow.style.display = 'none';
                button.textContent = 'View More';
            }
        }

        // Get authorized URL for viewing documents
        function getAuthorizedUrl(sourceUri, preferredUrl) {
            if (preferredUrl) return preferredUrl;
            if (!sourceUri) return '';

            if (sourceUri.startsWith('http://') || sourceUri.startsWith('https://')) {
                return sourceUri;
            }

            if (sourceUri.startsWith('gs://')) {
                const withoutScheme = sourceUri.slice(5);
                if (!withoutScheme) return '';

                const [bucket, ...pathParts] = withoutScheme.split('/');
                if (!bucket) return '';

                const encodedPath = pathParts.length
                    ? pathParts.map(part => encodeURIComponent(part)).join('/')
                    : '';

                return encodedPath
                    ? `https://storage.cloud.google.com/${bucket}/${encodedPath}`
                    : `https://storage.cloud.google.com/${bucket}`;
            }

            return sourceUri;
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Close modal when clicking outside
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal') {
                closeEditModal();
            }
        });
        
        // Delete document with cascading deletion
        async function deleteDocument(sourceId, title) {
            if (!isAdmin()) {
                showError('Admin access required');
                return;
            }
            
            // Show detailed confirmation
            const confirmMsg = `âš ï¸ CASCADING DELETE WARNING âš ï¸

This will permanently delete ALL data for:
"${title}"

The following will be deleted:
â€¢ Source file from Google Cloud Storage
â€¢ Processed chunks file (.jsonl)
â€¢ Generated summary file (.jsonl)
â€¢ All indexed chunk documents (${sourceId}_page_*)
â€¢ Indexed summary document
â€¢ Manifest entry

This action CANNOT be undone.

Type "DELETE" to confirm:`;
            
            const confirmation = prompt(confirmMsg);
            
            if (confirmation !== 'DELETE') {
                if (confirmation !== null) {
                    showError('Deletion cancelled - confirmation text did not match');
                }
                return;
            }
            
            // Show loading state
            showSuccess('Deleting... This may take a moment.');
            
            try {
                const result = await apiCall(`/admin/sources/${sourceId}`, 'DELETE');
                
                // Show detailed results
                let message = `Successfully deleted source "${title}"\n\n`;
                message += `Deleted:\n`;
                message += `â€¢ Source file: ${result.deleted.source_file ? 'âœ“' : 'âœ—'}\n`;
                message += `â€¢ Chunks file: ${result.deleted.chunks_file ? 'âœ“' : 'âœ—'}\n`;
                message += `â€¢ Summary file: ${result.deleted.summary_file ? 'âœ“' : 'âœ—'}\n`;
                message += `â€¢ Indexed chunks: ${result.deleted.indexed_chunks} documents\n`;
                message += `â€¢ Indexed summary: ${result.deleted.indexed_summary ? 'âœ“' : 'âœ—'}\n`;
                message += `â€¢ Manifest entry: ${result.deleted.manifest_entry ? 'âœ“' : 'âœ—'}`;
                
                if (result.errors && result.errors.length > 0) {
                    message += `\n\nWarnings:\n${result.errors.join('\n')}`;
                }
                
                alert(message);
                showSuccess('Document deleted successfully');
                loadManifest();
            } catch (error) {
                console.error('Failed to delete document:', error);
                showError('Failed to delete document: ' + error.message);
            }
        }
    </script>

    <style>
        .metadata-row td {
            border-top: none !important;
        }

        .tag-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
    </style>
</body>
</html>
